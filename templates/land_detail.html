{% extends "base.html" %}

{% block title %}{{ land.title }} - {{ t('app_title') }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="d-flex flex-wrap justify-content-between align-items-start gap-2">
            <div class="d-flex align-items-start gap-3">
                <button class="btn btn-outline-secondary btn-sm rounded-circle favorite-btn-header"
                        data-land-id="{{ land.id }}"
                        onclick="toggleFavorite({{ land.id }})"
                        title="{{ 'Remove from favorites' if land.is_favorite else 'Add to favorites' }}"
                        aria-label="Toggle favorite">
                    <i class="fas fa-star {{ 'text-warning' if land.is_favorite else 'text-muted' }}"></i>
                </button>
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-map-marker-alt me-2"></i>
                        {{ land.title }}
                    </h1>
                    <div class="d-flex flex-wrap align-items-center gap-2">
                        {% if land.listing_status == 'removed' %}
                            <span class="badge bg-danger">
                                <i class="fas fa-times-circle me-1"></i>REMOVED
                            </span>
                        {% elif land.listing_status == 'sold' %}
                            <span class="badge bg-secondary">
                                <i class="fas fa-check-circle me-1"></i>SOLD
                            </span>
                        {% endif %}
                        {% if land.municipality %}
                            <span class="text-body-secondary small">
                                <i class="fas fa-city me-1"></i>{{ land.municipality }}
                            </span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <a href="{{ url_for('main.lands', sort=request.args.get('sort'), order=request.args.get('order'), land_type=request.args.get('land_type'), municipality=request.args.get('municipality'), search=request.args.get('search'), per_page=request.args.get('per_page')) }}"
               class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left me-1"></i>Back to Properties
            </a>
    </div>
</div>

{% if land.listing_status in ('removed', 'sold') %}
<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-{{ 'danger' if land.listing_status == 'removed' else 'secondary' }} d-flex align-items-center" role="alert">
            <i class="fas fa-{{ 'times-circle' if land.listing_status == 'removed' else 'check-circle' }} me-3 fa-2x"></i>
            <div>
                <h5 class="mb-1">
                    {% if land.listing_status == 'removed' %}
                        This listing is no longer available on Idealista
                    {% else %}
                        This property has been sold
                    {% endif %}
                </h5>
                {% if land.listing_removed_date %}
                    <small>Removed on {{ land.listing_removed_date.strftime('%d %B %Y') }}</small>
                {% endif %}
            </div>
            <button class="btn btn-sm btn-outline-{{ 'danger' if land.listing_status == 'removed' else 'secondary' }} ms-auto"
                    onclick="checkListingStatus({{ land.id }})" id="recheck-btn">
                <i class="fas fa-sync-alt me-1"></i>Re-check Status
            </button>
        </div>
    </div>
</div>
{% endif %}

<div class="row" data-land-id="{{ land.id }}">
    <!-- Main Info -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2 py-2">
                <h2 class="h6 mb-0">
                    <i class="fas fa-info-circle me-2"></i>Overview
                </h2>
                <div class="d-flex align-items-center gap-2">
                    {% if land.score_total %}
                        <span class="badge score-badge" 
                              style="background-color: {{ 'var(--bs-success)' if land.score_total >= 70 else 'var(--bs-warning)' if land.score_total >= 50 else 'var(--bs-danger)' }}">
                            Score: {{ "%.1f"|format(land.score_total) }}
                        </span>
                    {% endif %}
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editScoreModal">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3 mb-3">
                    <div class="col-6 col-lg-3">
                        <div class="overview-stat bg-body-tertiary border rounded p-3 h-100">
                            <div class="overview-label text-body-secondary">
                                <i class="fas fa-euro-sign me-1"></i>Price
                            </div>
                            <div class="overview-value">
                                {% if land.price %}
                                    <span class="text-success">{{ "{:,.0f}".format(land.price) }}‚Ç¨</span>
                                {% else %}
                                    <span class="text-body-secondary">Not specified</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-lg-3">
                        <div class="overview-stat bg-body-tertiary border rounded p-3 h-100">
                            <div class="overview-label text-body-secondary">
                                <i class="fas fa-ruler-combined me-1"></i>Area
                            </div>
                            <div class="overview-value">
                                {% if land.area %}
                                    {{ "{:,.0f}".format(land.area) }} m¬≤
                                {% else %}
                                    <span class="text-body-secondary">Not specified</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-lg-3">
                        <div class="overview-stat bg-body-tertiary border rounded p-3 h-100">
                            <div class="overview-label text-body-secondary">
                                <i class="fas fa-city me-1"></i>Municipality
                            </div>
                            <div class="overview-value">
                                {{ land.municipality or 'Unknown' }}
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-lg-3">
                        <div class="overview-stat bg-body-tertiary border rounded p-3 h-100">
                            <div class="overview-label text-body-secondary">
                                <i class="fas fa-tag me-1"></i>Type
                            </div>
                            <div class="overview-value">
                                {% if land.land_type %}
                                    <span class="badge {{ 'bg-success' if land.land_type == 'developed' else 'bg-warning' }}">
                                        {{ land.land_type.title() }}
                                    </span>
                                {% else %}
                                    <span class="text-body-secondary">Unknown</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Location -->
                {% if land.location_lat and land.location_lon %}
                    <div class="overview-location bg-body-tertiary border rounded p-3 mb-4">
                        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                            <div>
                                <div class="overview-label text-body-secondary">
                                    <i class="fas fa-location-dot me-1"></i>Location
                                </div>
                                <div class="overview-value font-monospace">
                                    {{ "%.6f"|format(land.location_lat) }}, {{ "%.6f"|format(land.location_lon) }}
                                </div>
                            </div>
                            <div class="btn-group btn-group-sm" role="group" aria-label="Location links">
                                <a href="https://www.google.com/maps/search/?api=1&query={{ land.location_lat }},{{ land.location_lon }}"
                                   target="_blank" class="btn btn-outline-primary">
                                    <i class="fas fa-map me-1"></i>Google Maps
                                </a>
                                {% if land.url %}
                                <a href="{{ land.url }}"
                                   target="_blank" class="btn btn-outline-success">
                                    <i class="fas fa-home me-1"></i>Idealista
                                </a>
                                {% endif %}
                                <a href="{{ url_for('main.map_view', focus=land.id) }}"
                                   class="btn btn-outline-secondary"
                                   title="{{ t('view_on_app_map') }}">
                                    <i class="fas fa-map-marked-alt me-1"></i>Our Maps
                                </a>
                            </div>
                        </div>
                    </div>
                {% elif land.municipality %}
                    <div class="overview-location bg-body-tertiary border rounded p-3 mb-4">
                        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                            <div>
                                <div class="overview-label text-body-secondary">
                                    <i class="fas fa-location-dot me-1"></i>Location
                                </div>
                                <div class="overview-value">
                                    {{ land.municipality }}
                                </div>
                            </div>
                            <div class="btn-group btn-group-sm" role="group" aria-label="Location links">
                                <a href="https://www.google.com/maps/search/{{ land.municipality|urlencode }},+Spain"
                                   target="_blank" class="btn btn-outline-primary">
                                    <i class="fas fa-map me-1"></i>Google Maps
                                </a>
                                {% if land.url %}
                                <a href="{{ land.url }}"
                                   target="_blank" class="btn btn-outline-success">
                                    <i class="fas fa-home me-1"></i>Idealista
                                </a>
                                {% endif %}
                                <a href="{{ url_for('main.map_view', focus=land.id) }}"
                                   class="btn btn-outline-secondary"
                                   title="{{ t('view_on_app_map') }}">
                                    <i class="fas fa-map-marked-alt me-1"></i>Our Maps
                                </a>
                            </div>
                        </div>
                    </div>
                {% endif %}

                <!-- Enhanced Description -->
                {% if land.description %}
                    <div class="mb-4" id="description-section">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>Property Description:</strong>
                            <div class="d-flex gap-2">
                                <!-- Language Toggle -->
                                <div class="btn-group btn-group-sm" role="group" id="description-language-toggle" style="display: none;">
                                    <button type="button" class="btn btn-outline-secondary active" data-lang="en">
                                        <i class="fas fa-language me-1"></i>English
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" data-lang="es">
                                        <i class="fas fa-language me-1"></i>Spanish
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" data-lang="original">
                                        <i class="fas fa-home me-1"></i>Idealista
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Description Content -->
                        <div class="mt-2 p-3 bg-body-tertiary border rounded position-relative" id="description-content">
                            
                            <!-- Enhanced Description -->
                            <div id="enhanced-description" style="display: none;">
                                <div class="text-body" id="enhanced-description-text"></div>
                                <div class="mt-2" id="description-highlights" style="display: none;">
                                    <small class="text-muted d-block mb-1">Key Highlights:</small>
                                    <div id="highlights-list"></div>
                                </div>
                                <div class="mt-2" id="price-info-section" style="display: none;">
                                    <small class="text-success">üí∞ <span id="price-info-text"></span></small>
                                </div>
                            </div>
                            
                            <!-- Original Description -->
                            <div id="original-description">
                                {{ land.description }}
                            </div>
                        </div>
                    </div>
                {% endif %}
                
                <!-- Property Details from Idealista -->
                {% if land.property_details %}
                    {% if land.property_details is string %}
                        <!-- Display as plain text if it's a string -->
                            <div class="mb-4">
                                <strong>Property Details:</strong>
                            <div class="mt-2 p-3 bg-body-tertiary border rounded">
                                <pre class="text-body mb-0" style="white-space: pre-wrap; word-wrap: break-word;">{{ land.property_details }}</pre>
                            </div>
                        </div>
                    {% else %}
                        <!-- Skip if it's JSON data (AI analysis should go to separate section) -->
                    {% endif %}
                {% endif %}

                <!-- AI Analysis Section -->
                <div id="ai-analysis-section" class="mt-4">
                    <div class="card">
                        <div class="card-header py-2">
                            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                                <ul class="nav nav-tabs card-header-tabs" id="ai-analysis-tabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="ai-claude-tab" data-bs-toggle="tab" data-bs-target="#ai-claude-pane" type="button" role="tab" aria-controls="ai-claude-pane" aria-selected="true">
                                            <i class="fas fa-brain me-1"></i>Claude
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="ai-chatgpt-tab" data-bs-toggle="tab" data-bs-target="#ai-chatgpt-pane" type="button" role="tab" aria-controls="ai-chatgpt-pane" aria-selected="false">
                                            <i class="fas fa-robot me-1"></i>ChatGPT
                                        </button>
                                    </li>
                                </ul>
                                <div class="small text-body-secondary">
                                    <i class="fas fa-chart-line me-1"></i>AI Investment Analysis
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="tab-content" id="ai-analysis-tab-content">
                                <div class="tab-pane fade show active" id="ai-claude-pane" role="tabpanel" aria-labelledby="ai-claude-tab" tabindex="0">
                                    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
                                        <div class="small text-body-secondary" id="ai-claude-model-label">
                                            Powered by Claude
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-primary" id="ai-claude-run-btn" onclick="runClaudeAnalysis({{ land.id }})">
                                            <i class="fas fa-wand-magic-sparkles me-1"></i>Run Claude
                                        </button>
                                    </div>
                                    <div id="ai-claude-alerts"></div>
                                    <div class="analysis-content" id="ai-claude-analysis">
                                        <div id="ai-claude-structured-analysis"></div>
                                        <div class="text-center text-muted py-4" id="ai-claude-placeholder" style="{{ 'display: none;' if land.ai_analysis else '' }}">
                                            <i class="fas fa-brain fa-3x mb-3 opacity-50"></i>
                                            <p class="mb-0">No analysis yet</p>
                                            <small class="d-block text-body-secondary mt-1">Click ‚ÄúRun Claude‚Äù to generate it.</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="ai-chatgpt-pane" role="tabpanel" aria-labelledby="ai-chatgpt-tab" tabindex="0">
                                    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
                                        <div class="small text-body-secondary" id="ai-chatgpt-model-label">
                                            Powered by ChatGPT{% if openai_model %} ({{ openai_model }}){% endif %}
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-primary" id="ai-chatgpt-run-btn" onclick="generateChatGPTAnalysis()">
                                            <i class="fas fa-wand-magic-sparkles me-1"></i>Run ChatGPT
                                        </button>
                                    </div>
                                    <div id="ai-chatgpt-alerts"></div>
                                    <div class="analysis-content" id="ai-chatgpt-analysis">
                                        <div id="ai-chatgpt-structured-analysis"></div>
                                        <div class="text-center text-muted py-4" id="ai-chatgpt-placeholder" style="{{ 'display: none;' if openai_analysis else '' }}">
                                            <i class="fas fa-robot fa-3x mb-3 opacity-50"></i>
                                            <p class="mb-0">No analysis yet</p>
                                            <small class="d-block text-body-secondary mt-1">Click ‚ÄúRun ChatGPT‚Äù to generate it.</small>
                                            <small class="d-block text-body-secondary mt-1" id="ai-chatgpt-config-hint"></small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Claude vs ChatGPT comparison -->
                <div class="mt-3" id="ai-compare-section">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-scale-balanced me-2"></i>Claude vs ChatGPT
                            </h6>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshAiComparison()">
                                    <i class="fas fa-rotate me-1"></i>Refresh
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="ai-compare-status" class="small text-body-secondary">Loading‚Ä¶</div>
                            <div class="table-responsive mt-2">
                                <table class="table table-sm align-middle mb-0" id="ai-compare-table" style="display:none;">
                                    <thead>
                                        <tr>
                                            <th style="min-width: 190px;">Metric</th>
                                            <th style="min-width: 160px;">Claude</th>
                                            <th style="min-width: 160px;">ChatGPT</th>
                                            <th style="min-width: 160px;">Baseline</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ai-compare-tbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="mt-4 d-flex justify-content-center gap-2" style="flex-wrap: nowrap;">
                    {% if land.url %}
                        <a href="{{ land.url }}" target="_blank" class="btn btn-success">
                            <i class="fas fa-home me-2"></i>
                            View on Idealista
                        </a>
                    {% endif %}
                    
                    <!-- AI Analysis shortcut (opens Claude tab) -->
                    <button type="button" class="btn btn-outline-info" onclick="openAiSection('claude')">
                        <i class="fas fa-brain me-2"></i>AI Analyses
                    </button>
                    
                    
                    <!-- Google Enrichment Button - highlighted if enrichment data exists -->
                    {% set has_enrichment = land.infrastructure_basic or land.infrastructure_extended or land.transport or (land.travel_time_airport or land.travel_time_train_station or land.travel_time_hospital) %}
                    <button class="btn {{ 'btn-success' if has_enrichment else 'btn-outline-warning' }}"
                            hx-post="{{ url_for('api.manual_enrichment', land_id=land.id) }}"
                            hx-trigger="click"
                            hx-indicator="#enrichment-spinner"
                            hx-swap="none"
                            data-enrich-label="Enrich with Google APIs">
                        <i class="fas fa-sync me-2 {{ 'text-white' if has_enrichment else '' }}"></i>
                        Enrich with Google APIs
                        {% if has_enrichment %}
                            <span class="badge bg-light text-dark ms-1">‚úì</span>
                        {% endif %}
                    </button>

                    <!-- Mark as Removed Button (dropdown for status options) -->
                    {% if land.listing_status == 'active' %}
                    <div class="dropdown">
                        <button class="btn btn-outline-danger dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-times-circle me-1"></i>Mark Status
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="setListingStatus({{ land.id }}, 'removed'); return false;">
                                <i class="fas fa-times-circle text-danger me-2"></i>Mark as Removed
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="setListingStatus({{ land.id }}, 'sold'); return false;">
                                <i class="fas fa-check-circle text-secondary me-2"></i>Mark as Sold
                            </a></li>
                        </ul>
                    </div>
                    {% else %}
                    <button class="btn btn-outline-success" onclick="setListingStatus({{ land.id }}, 'active')">
                        <i class="fas fa-undo me-1"></i>Mark as Active
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Dual Scoring System - Hidden since we show compact version in sidebar -->
        {% if False %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Dual Scoring Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Investment vs Lifestyle Scores -->
                    {% if land.score_investment or land.score_lifestyle %}
                        <div class="row mb-4">
                            {% if land.score_investment %}
                                <div class="col-md-6 mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="fw-bold text-warning">
                                            <i class="fas fa-chart-line me-1"></i>Investment Score
                                        </span>
                                        <span class="badge bg-warning text-dark fs-6">{{ "%.1f"|format(land.score_investment) }}</span>
                                    </div>
                                    <div class="progress mb-1" style="height: 8px;">
                                        <div class="progress-bar bg-warning" 
                                             style="width: {{ land.score_investment }}%;">
                                        </div>
                                    </div>
                                    <small class="text-muted">Rental yield, ROI, value appreciation</small>
                                </div>
                            {% endif %}
                            {% if land.score_lifestyle %}
                                <div class="col-md-6 mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="fw-bold text-success">
                                            <i class="fas fa-home me-1"></i>Lifestyle Score
                                        </span>
                                        <span class="badge bg-success fs-6">{{ "%.1f"|format(land.score_lifestyle) }}</span>
                                    </div>
                                    <div class="progress mb-1" style="height: 8px;">
                                        <div class="progress-bar bg-success" 
                                             style="width: {{ land.score_lifestyle }}%;">
                                        </div>
                                    </div>
                                    <small class="text-muted">Environment, amenities, quality of life</small>
                                </div>
                            {% endif %}
                        </div>
                        <hr>
                    {% endif %}

                    <!-- Detailed Criteria Breakdown -->
                    {% if score_breakdown %}
                        {% if score_breakdown.get('score_breakdown') %}
                            <h6 class="mb-3">Criteria Breakdown</h6>
                            <div class="row">
                                {% for criteria, score in score_breakdown.get('score_breakdown', {}).items() %}
                                    {% if score is not none %}
                                        <div class="col-md-6 mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <span class="small">{{ criteria.replace('_', ' ').title() }}</span>
                                                <span class="badge bg-secondary">{{ "%.1f"|format(score) }}</span>
                                            </div>
                                            <div class="progress" style="height: 6px;">
                                                <div class="progress-bar" 
                                                     style="width: {{ score }}%; background-color: {{ 'var(--bs-success)' if score >= 70 else 'var(--bs-warning)' if score >= 50 else 'var(--bs-danger)' }};">
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        <!-- Combined Mix Information -->
                        {% if score_breakdown.get('combined_mix') %}
                            <hr>
                            <div class="mt-3">
                                <h6 class="mb-2">Score Composition</h6>
                                <div class="d-flex align-items-center">
                                    <span class="small me-2">Investment {{ (score_breakdown.combined_mix.investment * 100)|round }}%</span>
                                    <div class="progress flex-grow-1 me-2" style="height: 20px;">
                                        <div class="progress-bar bg-warning" 
                                             style="width: {{ (score_breakdown.combined_mix.investment * 100)|round }}%;">
                                        </div>
                                        <div class="progress-bar bg-success" 
                                             style="width: {{ (score_breakdown.combined_mix.lifestyle * 100)|round }}%;">
                                        </div>
                                    </div>
                                    <span class="small">Lifestyle {{ (score_breakdown.combined_mix.lifestyle * 100)|round }}%</span>
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Loading indicator for enrichment -->
        <div id="enrichment-spinner" class="htmx-indicator">
            <div class="alert alert-info">
                <i class="fas fa-spinner fa-spin me-2"></i>
                Enriching property with Google API data...
            </div>
        </div>
        
        <!-- Compact Dual Scoring Analysis -->
        {% if land.score_investment or land.score_lifestyle %}
            <div class="card mb-3">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0 compact-header" title="{{ t('dual_scoring_analysis') }}">
                            <i class="fas fa-chart-bar me-1"></i>{{ t('dual_scoring_analysis') }}
                        </h6>
                    </div>
                    <div class="row g-2">
                        {% if land.score_investment %}
                            <div class="col-6">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="text-warning fw-bold compact-text" title="{{ t('investment_score') }}">
                                        <i class="fas fa-coins"></i> {{ t('investment_score') }}
                                    </small>
                                    <span class="badge bg-warning text-dark">{{ "%.0f"|format(land.score_investment) }}</span>
                                </div>
                            </div>
                        {% endif %}
                        {% if land.score_lifestyle %}
                            <div class="col-6">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="text-success fw-bold compact-text" title="{{ t('lifestyle_score') }}">
                                        <i class="fas fa-home"></i> {{ t('lifestyle_score') }}
                                    </small>
                                    <span class="badge bg-success">{{ "%.0f"|format(land.score_lifestyle) }}</span>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Travel Times to Cities & Beaches -->
        {% if land.travel_time_oviedo or land.travel_time_gijon or land.travel_time_airport or land.travel_time_train_station or land.travel_time_hospital or land.travel_time_police or land.distance_airport or land.distance_train_station %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0 compact-header" title="{{ t('travel_times_distances') }}">
                        <i class="fas fa-map-marked-alt me-2"></i>{{ t('travel_times_distances') }}
                    </h6>
                </div>
                <div class="card-body">
                    {% if reference_cities and reference_cities|length > 0 %}
                        <!-- Reference Cities (configurable) -->
                        {% for city in reference_cities %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small fw-bold compact-text" title="{{ city.name }}">
                                    <i class="fas fa-city me-1 text-warning"></i>{{ city.name }}
                                </span>
                                <div>
                                    {% if city.travel_time_min %}<span class="badge bg-info me-1">{{ city.travel_time_min }}min</span>{% endif %}
                                    {% if city.distance_km is not none %}<span class="badge bg-secondary">{{ city.distance_km }}km</span>{% endif %}
                                </div>
                            </div>
                        {% endfor %}
                        <hr class="my-2">
                    {% endif %}

                    <!-- Major Cities & Transport Hubs -->
                    {% if land.travel_time_airport or land.distance_airport %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small fw-bold compact-text" title="{{ t('nearest_airport') }}"><i class="fas fa-plane me-1 text-primary"></i>{{ t('nearest_airport') }}</span>
                            <div>
                                {% if land.travel_time_airport %}<span class="badge bg-info me-1">{{ land.travel_time_airport }}min</span>{% endif %}
                                {% if land.distance_airport %}<span class="badge bg-secondary">{{ land.distance_airport }}km</span>{% endif %}
                            </div>
                        </div>
                    {% endif %}
                    
                    {% if land.travel_time_train_station or land.distance_train_station %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small fw-bold compact-text" title="{{ t('train_station') }}"><i class="fas fa-train me-1 text-success"></i>{{ t('train_station') }}</span>
                            <div>
                                {% if land.travel_time_train_station %}<span class="badge bg-info me-1">{{ land.travel_time_train_station }}min</span>{% endif %}
                                {% if land.distance_train_station %}<span class="badge bg-secondary">{{ land.distance_train_station }}km</span>{% endif %}
                            </div>
                        </div>
                    {% endif %}
                    
                    {% if land.travel_time_hospital or land.distance_hospital %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small fw-bold compact-text" title="{{ t('hospital') }}"><i class="fas fa-hospital me-1 text-danger"></i>{{ t('hospital') }}</span>
                            <div>
                                {% if land.travel_time_hospital %}<span class="badge bg-info me-1">{{ land.travel_time_hospital }}min</span>{% endif %}
                                {% if land.distance_hospital %}<span class="badge bg-secondary">{{ land.distance_hospital }}km</span>{% endif %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}


        <!-- Infrastructure Basic -->
        {% if land.infrastructure_basic %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0 compact-header" title="{{ t('basic_infrastructure') }}">
                        <i class="fas fa-tools me-2"></i>{{ t('basic_infrastructure') }}
                    </h6>
                </div>
                <div class="card-body">
                    {% for key, value in land.infrastructure_basic.items() %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>{{ key.replace('_', ' ').title() }}</span>
                            {% if value is sameas true %}
                                <i class="fas fa-check-circle text-success"></i>
                            {% elif value is sameas false %}
                                <i class="fas fa-times-circle text-danger"></i>
                            {% else %}
                                <span class="text-muted">{{ value }}</span>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <!-- Infrastructure Extended -->
        {% if land.infrastructure_extended %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0 compact-header" title="{{ t('extended_infrastructure') }}">
                        <i class="fas fa-building me-2"></i>{{ t('extended_infrastructure') }}
                    </h6>
                </div>
                <div class="card-body">
                    {% for key, value in land.infrastructure_extended.items() %}
                        {% if key == 'osm_amenities' and value is mapping %}
                            <div class="mb-3">
                                <span class="small fw-bold">Nearby Amenities:</span>
                                <div class="mt-2">
                                    <!-- Priority Amenities (Top of list) -->
                                    {% for priority_amenity in ['hospital', 'pharmacy', 'police', 'bank'] %}
                                        {% if priority_amenity in value %}
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <span class="small text-capitalize fw-bold">
                                                    {% if priority_amenity == 'hospital' %}
                                                        <i class="fas fa-hospital me-1 text-danger"></i> Hospitals
                                                    {% elif priority_amenity == 'pharmacy' %}
                                                        <i class="fas fa-pills me-1 text-success"></i> Pharmacies
                                                    {% elif priority_amenity == 'police' %}
                                                        <i class="fas fa-shield-alt me-1 text-primary"></i> Police Stations
                                                    {% elif priority_amenity == 'bank' %}
                                                        <i class="fas fa-university me-1 text-info"></i> Banks
                                                    {% endif %}
                                                </span>
                                                <span class="badge bg-primary">{{ value[priority_amenity] }} nearby</span>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <!-- Separator if we have priority amenities -->
                                    {% if (value.get('hospital') or value.get('pharmacy') or value.get('police') or value.get('bank')) and value.items()|length > (1 if (value.get('hospital') or value.get('pharmacy') or value.get('police') or value.get('bank')) else 0) %}
                                        <hr class="my-2">
                                    {% endif %}
                                    
                                    <!-- Regular Amenities -->
                                    {% for amenity, count in value.items() %}
                                        {% if amenity not in ['hospital', 'pharmacy', 'police', 'bank'] %}
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <span class="small text-capitalize">
                                                    {% if amenity == 'cafe' %}
                                                        <i class="fas fa-coffee me-1"></i> Cafes
                                                    {% elif amenity == 'restaurant' %}
                                                        <i class="fas fa-utensils me-1"></i> Restaurants
                                                    {% elif amenity == 'school' %}
                                                        <i class="fas fa-graduation-cap me-1"></i> Schools
                                                    {% elif amenity == 'fuel' %}
                                                        <i class="fas fa-gas-pump me-1"></i> Gas Stations
                                                    {% elif amenity == 'supermarket' %}
                                                        <i class="fas fa-shopping-cart me-1"></i> Supermarkets
                                                    {% else %}
                                                        <i class="fas fa-map-marker-alt me-1"></i> {{ amenity.replace('_', ' ').title() }}
                                                    {% endif %}
                                                </span>
                                                <span class="badge bg-primary">{{ count }} nearby</span>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        {% else %}
                            {% set base_key = key.replace('_available', '').replace('_distance', '').replace('_travel_time', '') %}
                            {% set has_distance = land.infrastructure_extended.get(base_key + '_distance') if land.infrastructure_extended else None %}
                            {% set has_travel_time = land.infrastructure_extended.get(base_key + '_travel_time') if land.infrastructure_extended else None %}
                            
                            <!-- Skip 'available' fields if we have distance/travel_time data, and skip zero distances -->
                            {% if not (
                                key.endswith('_available') and (has_distance or has_travel_time)
                            ) and not (
                                key.endswith('_distance') and value == 0
                            ) %}
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="small">{{ key.replace('_', ' ').title() }}</span>
                                    {% if value is sameas true %}
                                        <i class="fas fa-check-circle text-success"></i>
                                    {% elif value is sameas false %}
                                        <i class="fas fa-times-circle text-danger"></i>
                                    {% elif value is number %}
                                        {% if 'distance' in key %}
                                            {% set distance_km = value/1000 %}
                                            {% set travel_time_value = land.infrastructure_extended.get(base_key + '_travel_time') if land.infrastructure_extended else None %}
                                            <div class="d-flex align-items-center">
                                                {% if travel_time_value %}
                                                    <!-- Car time -->
                                                    <span class="badge bg-info me-1">
                                                        <i class="fas fa-car me-1"></i>{{ travel_time_value }}min
                                                    </span>
                                                    {% set walking_time = (travel_time_value * 4)|int %}
                                                    {% if walking_time <= 15 %}
                                                        <!-- Walking time (only if <= 15 min) -->
                                                        <span class="badge bg-success me-1">
                                                            <i class="fas fa-walking me-1"></i>{{ walking_time }}min
                                                        </span>
                                                    {% endif %}
                                                {% endif %}
                                                <span class="badge bg-secondary">{{ "%.1f"|format(distance_km) }}km</span>
                                            </div>
                                        {% elif 'travel_time' in key %}
                                            {% set distance_value = land.infrastructure_extended.get(base_key + '_distance') if land.infrastructure_extended else None %}
                                            <div class="d-flex align-items-center">
                                                <!-- Car time -->
                                                <span class="badge bg-info me-1">
                                                    <i class="fas fa-car me-1"></i>{{ value }}min
                                                </span>
                                                {% set walking_time = (value * 4)|int %}
                                                {% if walking_time <= 15 %}
                                                    <!-- Walking time (only if <= 15 min) -->
                                                    <span class="badge bg-success me-1">
                                                        <i class="fas fa-walking me-1"></i>{{ walking_time }}min
                                                    </span>
                                                {% endif %}
                                                {% if distance_value %}
                                                    <span class="badge bg-secondary">{{ "%.1f"|format(distance_value/1000) }}km</span>
                                                {% endif %}
                                            </div>
                                        {% else %}
                                            {% if 'duration' in key or 'time' in key %}
                                                <span class="badge bg-info">{{ value }}min</span>
                                            {% elif 'distance' in key %}
                                                <span class="badge bg-secondary">{{ "%.1f"|format(value/1000) }}km</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ value }}</span>
                                            {% endif %}
                                        {% endif %}
                                    {% elif value is mapping %}
                                        <!-- Handle other dictionary values -->
                                        <div class="small">
                                            {% for k, v in value.items() %}
                                                <div>{{ k }}: {{ v }}</div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <span class="text-muted small">{{ value }}</span>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <!-- Transport -->
        {% if land.transport or land.travel_time_airport or land.travel_time_train_station or land.travel_time_hospital or land.travel_time_police %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0 compact-header" title="{{ t('transport') }}">
                        <i class="fas fa-route me-2"></i>{{ t('transport') }}
                    </h6>
                </div>
                <div class="card-body">
                    <!-- Priority Infrastructure (Top of list) -->
                    {% if land.transport and land.transport.get('airport_available') == false %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small fw-bold"><i class="fas fa-plane me-1"></i>Airport</span>
                            <div>
                                <i class="fas fa-times-circle text-danger"></i>
                                <small class="text-muted ms-1">Not available</small>
                            </div>
                        </div>
                    {% elif land.travel_time_airport %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small fw-bold">Airport Distance</span>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-info me-1">
                                    <i class="fas fa-car me-1"></i>{{ land.travel_time_airport }}min
                                </span>
                                {% if land.distance_airport %}
                                    {% set walking_time = (land.travel_time_airport * 4)|int %}
                                    {% if walking_time <= 15 %}
                                        <span class="badge bg-success me-1">
                                            <i class="fas fa-walking me-1"></i>{{ walking_time }}min
                                        </span>
                                    {% endif %}
                                    <span class="badge bg-secondary">{{ land.distance_airport }}km</span>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                    {% if land.travel_time_train_station %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small fw-bold">Train Station Distance</span>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-info me-1">
                                    <i class="fas fa-car me-1"></i>{{ land.travel_time_train_station }}min
                                </span>
                                {% if land.distance_train_station %}
                                    {% set walking_time = (land.travel_time_train_station * 4)|int %}
                                    {% if walking_time <= 15 %}
                                        <span class="badge bg-success me-1">
                                            <i class="fas fa-walking me-1"></i>{{ walking_time }}min
                                        </span>
                                    {% endif %}
                                    <span class="badge bg-secondary">{{ land.distance_train_station }}km</span>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                    {% if land.travel_time_hospital %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small fw-bold">Hospital Distance</span>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-info me-1">
                                    <i class="fas fa-car me-1"></i>{{ land.travel_time_hospital }}min
                                </span>
                                {% if land.distance_hospital %}
                                    {% set walking_time = (land.travel_time_hospital * 4)|int %}
                                    {% if walking_time <= 15 %}
                                        <span class="badge bg-success me-1">
                                            <i class="fas fa-walking me-1"></i>{{ walking_time }}min
                                        </span>
                                    {% endif %}
                                    <span class="badge bg-secondary">{{ land.distance_hospital }}km</span>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                    {% if land.travel_time_police %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small fw-bold">Police Station Distance</span>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-info me-1">
                                    <i class="fas fa-car me-1"></i>{{ land.travel_time_police }}min
                                </span>
                                {% if land.distance_police %}
                                    {% set walking_time = (land.travel_time_police * 4)|int %}
                                    {% if walking_time <= 15 %}
                                        <span class="badge bg-success me-1">
                                            <i class="fas fa-walking me-1"></i>{{ walking_time }}min
                                        </span>
                                    {% endif %}
                                    <span class="badge bg-secondary">{{ land.distance_police }}km</span>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Separator if we have both priority and regular transport data -->
                    {% if (land.travel_time_airport or land.travel_time_train_station or land.travel_time_hospital or land.travel_time_police) and land.transport %}
                        <hr class="my-3">
                    {% endif %}
                    
                    <!-- Regular Transport Data -->
                    {% if land.transport %}
                        {% for key, value in land.transport.items() %}
                            {% set base_key = key.replace('_available', '').replace('_distance', '').replace('_travel_time', '') %}
                            {% set has_distance_field = land.transport.get(base_key + '_distance') if land.transport else None %}
                            {% set has_travel_time_field = land.transport.get(base_key + '_travel_time') if land.transport else None %}
                            
                            <!-- Skip 'available' and individual 'travel_time' fields if we already show combined data above -->
                            {% if not (
                                (key.endswith('_available') and (has_distance_field or has_travel_time_field)) or
                                (key.endswith('_travel_time') and has_distance_field) or
                                (key.startswith('duration_to_')) or
                                (key == 'airport_available' and land.travel_time_airport)
                            ) %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small">{{ key.replace('_', ' ').title() }}</span>
                                {% if value is sameas true %}
                                    <i class="fas fa-check-circle text-success"></i>
                                {% elif value is sameas false %}
                                    <i class="fas fa-times-circle text-danger"></i>
                                {% elif value is number and 'distance' in key %}
                                    <div class="d-flex align-items-center">
                                        {% if key.startswith('distance_to_') %}
                                            <!-- Major cities: show car time + distance in one line -->
                                            {% set duration_key = key.replace('distance_to_', 'duration_to_') %}
                                            {% set duration_value = land.transport.get(duration_key) %}
                                            {% if value == 0 and not duration_value %}
                                                <span class="text-muted small">no data</span>
                                            {% else %}
                                                {% if duration_value %}
                                                    <span class="badge bg-info me-1">
                                                        <i class="fas fa-car me-1"></i>{{ "%.0f"|format(duration_value/60) }}min
                                                    </span>
                                                {% endif %}
                                                <span class="badge bg-secondary">
                                                    <i class="fas fa-road me-1"></i>{{ "%.0f"|format(value/1000) }}km
                                                </span>
                                            {% endif %}
                                        {% else %}
                                            <!-- Local transport: show car time + walking time + distance -->
                                            {% set transport_type = key.replace('_distance', '') %}
                                            {% if land.transport and land.transport.get(transport_type + '_travel_time') %}
                                                <span class="badge bg-info me-1">
                                                    <i class="fas fa-car me-1"></i>{{ land.transport[transport_type + '_travel_time'] }}min
                                                </span>
                                                {% set walking_time = (land.transport[transport_type + '_travel_time'] * 4)|int %}
                                                {% if walking_time <= 15 %}
                                                    <span class="badge bg-success me-1">
                                                        <i class="fas fa-walking me-1"></i>{{ walking_time }}min
                                                    </span>
                                                {% endif %}
                                            {% endif %}
                                            {% if value < 1000 %}
                                                <span class="badge bg-secondary">
                                                    <i class="fas fa-road me-1"></i>{{ "%.1f"|format(value/1000) }}km
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary">
                                                    <i class="fas fa-road me-1"></i>{{ "%.0f"|format(value/1000) }}km
                                                </span>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                {% elif value is number and 'duration' in key %}
                                    <span class="badge bg-info">{{ "%.0f"|format(value/60) }}min</span>
                                {% elif value is number and key.endswith('_travel_time') %}
                                    <span class="badge bg-info">
                                        <i class="fas fa-car me-1"></i>{{ value }}min
                                    </span>
                                {% else %}
                                    <span class="text-muted small">{{ value }}</span>
                                {% endif %}
                            </div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        {% endif %}

        <!-- Environment -->
        {% if land.environment %}
            {% set environment_items = [] %}
            {% for key, value in land.environment.items() %}
                {% if key != 'score_breakdown' %}
                    {% set _ = environment_items.append((key, value)) %}
                {% endif %}
            {% endfor %}
            
            {% if environment_items %}
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-leaf me-2"></i>{{ t('environment') }}
                        </h6>
                        <button class="btn btn-sm btn-outline-primary" onclick="toggleEnvironmentEdit({{ land.id }})" id="env-edit-btn">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                    <div class="card-body" id="environment-display">
                        {% for key, value in environment_items %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                {% if key in ['sea_view', 'forest_view', 'mountain_view'] %}
                                    <span class="small">{{ key.replace('_view', '').replace('_', ' ').title() }} View</span>
                                    {% if value is sameas true %}
                                        <i class="fas fa-check-circle text-success"></i>
                                    {% elif value is sameas false %}
                                        <i class="fas fa-times-circle text-danger"></i>
                                    {% else %}
                                        <span class="text-muted small">N/A</span>
                                    {% endif %}
                                {% else %}
                                    <span class="small">{{ key.replace('_', ' ').title() }}</span>
                                    {% if value is sameas true %}
                                        <i class="fas fa-check-circle text-success"></i>
                                    {% elif value is sameas false %}
                                        <i class="fas fa-times-circle text-danger"></i>
                                    {% else %}
                                        <span class="text-muted small">{{ value if value else 'N/A' }}</span>
                                    {% endif %}
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                    <!-- Edit Form (hidden by default) -->
                    <div class="card-body" id="environment-edit" style="display: none;">
                        <form id="environment-form" onsubmit="saveEnvironment(event, {{ land.id }})">
                            <div class="mb-3">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="sea_view" name="sea_view" 
                                           {{ 'checked' if land.environment.get('sea_view') }}>
                                    <label class="form-check-label" for="sea_view">Sea View</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="mountain_view" name="mountain_view" 
                                           {{ 'checked' if land.environment.get('mountain_view') }}>
                                    <label class="form-check-label" for="mountain_view">Mountain View</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="forest_view" name="forest_view" 
                                           {{ 'checked' if land.environment.get('forest_view') }}>
                                    <label class="form-check-label" for="forest_view">Forest View</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="orientation" class="form-label small">Orientation</label>
                                <input type="text" class="form-control form-control-sm" id="orientation" name="orientation" 
                                       value="{{ land.environment.get('orientation', '') }}">
                            </div>
                            <div class="mb-3">
                                <label for="buildable_floors" class="form-label small">Buildable Floors</label>
                                <input type="text" class="form-control form-control-sm" id="buildable_floors" name="buildable_floors" 
                                       value="{{ land.environment.get('buildable_floors', '') }}">
                            </div>
                            <div class="mb-3">
                                <label for="access_type" class="form-label small">Access Type</label>
                                <input type="text" class="form-control form-control-sm" id="access_type" name="access_type" 
                                       value="{{ land.environment.get('access_type', '') }}">
                            </div>
                            <div class="mb-3">
                                <label for="certified_for" class="form-label small">Certified For</label>
                                <input type="text" class="form-control form-control-sm" id="certified_for" name="certified_for" 
                                       value="{{ land.environment.get('certified_for', '') }}">
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-sm btn-success">Save</button>
                                <button type="button" class="btn btn-sm btn-secondary" onclick="cancelEnvironmentEdit()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            {% endif %}
        {% endif %}

        <!-- Services Quality -->
        {% if land.services_quality %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-star me-2"></i>{{ t('services_quality') }}
                    </h6>
                </div>
                <div class="card-body">
                    {% for key, value in land.services_quality.items() %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small">{{ key.replace('_', ' ').title() }}</span>
                            {% if value is number %}
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-warning me-2">{{ "%.1f"|format(value) }}/5</span>
                                    <div class="small">
                                        {% set rounded_rating = (value * 2)|round / 2 %}
                                        {% set full_stars = rounded_rating|int %}
                                        {% set has_half = (rounded_rating - full_stars) >= 0.5 %}
                                        
                                        {% for i in range(1, 6) %}
                                            {% if i <= full_stars %}
                                                <!-- Full star -->
                                                <i class="fas fa-star text-warning"></i>
                                            {% elif i == full_stars + 1 and has_half %}
                                                <!-- Half star -->
                                                <i class="fas fa-star-half-alt text-warning"></i>
                                            {% else %}
                                                <!-- Empty star -->
                                                <i class="far fa-star text-muted"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            {% else %}
                                <span class="text-muted small">{{ value }}</span>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <!-- Investment Analysis -->
        {% if land.ai_analysis %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>Investment Analysis
                    </h6>
                </div>
                <div class="card-body">
                    <!-- Rental Market Data -->
                    {% if land.ai_analysis.get('rental_market_analysis') %}
                        {% set rental_data = land.ai_analysis.rental_market_analysis %}
                        {% if rental_data.get('expected_monthly_rent') or rental_data.get('rental_yield') %}
                            <div class="mb-3">
                                <h6 class="small fw-bold mb-2">Rental Market</h6>
                                {% if rental_data.get('expected_monthly_rent') %}
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="small">Monthly Rent</span>
                                        <span class="badge bg-success">‚Ç¨{{ rental_data.expected_monthly_rent }}/month</span>
                                    </div>
                                {% endif %}
                                {% if rental_data.get('rental_yield') %}
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="small">Rental Yield</span>
                                        <span class="badge bg-warning">{{ rental_data.rental_yield }}%</span>
                                    </div>
                                {% endif %}
                                {% if rental_data.get('cap_rate') %}
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="small">Cap Rate</span>
                                        <span class="badge bg-info">{{ rental_data.cap_rate }}%</span>
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endif %}

                    <!-- Investment Potential -->
                    {% if land.ai_analysis.get('investment_potential') %}
                        {% set investment = land.ai_analysis.investment_potential %}
                        <div class="mb-3">
                            <h6 class="small fw-bold mb-2">Investment Rating</h6>
	                            {% if investment.get('rating') %}
	                                <div class="d-flex justify-content-between mb-1">
	                                    <span class="small">Rating</span>
	                                    <span class="badge {{ 'bg-success' if investment.rating == 'HIGH' else 'bg-warning' if investment.rating == 'MEDIUM' else 'bg-secondary' }}">
	                                        {{ investment.rating.replace('_', ' ').title() }}
	                                    </span>
	                                </div>
	                            {% endif %}
	                            {% if investment.get('risk_level') %}
	                                <div class="d-flex justify-content-between mb-1">
	                                    <span class="small">Risk Level</span>
	                                    <span class="badge {{ 'bg-danger' if investment.risk_level == 'HIGH' else 'bg-warning' if investment.risk_level == 'MEDIUM' else 'bg-success' }}">
	                                        {{ investment.risk_level.replace('_', ' ').title() }}
	                                    </span>
	                                </div>
	                            {% endif %}
                            {% if investment.get('forecast') %}
                                <div class="mb-1">
                                    <small class="text-muted">{{ investment.forecast }}</small>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}

                    <!-- Market Position -->
	                    {% if land.ai_analysis.get('comparable_analysis') %}
	                        {% set comparable = land.ai_analysis.comparable_analysis %}
	                        <div class="mb-3">
	                            <h6 class="small fw-bold mb-2">Market Position</h6>
	                            {% if comparable.get('market_position') %}
	                                <div class="mb-1">
	                                    {% set market_position = comparable.market_position %}
	                                    <small class="text-info">
	                                        {% if market_position and market_position|upper == market_position %}
	                                            {{ market_position|replace('_', ' ')|title }}
	                                        {% else %}
	                                            {{ market_position }}
	                                        {% endif %}
	                                    </small>
	                                </div>
	                            {% endif %}
	                            {% if comparable.get('price_comparison') %}
	                                <div class="mb-1">
	                                    <small class="text-muted">{{ comparable.price_comparison }}</small>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}

                    <!-- Construction Value -->
                    {% if land.ai_analysis.get('construction_value_estimation') %}
                        {% set construction = land.ai_analysis.construction_value_estimation %}
                        {% if construction.get('total_investment') or construction.get('value_per_m2') %}
                            <div class="mb-3">
                                <h6 class="small fw-bold mb-2">Development Cost</h6>
                                {% if construction.get('total_investment') %}
                                    <div class="kv-row mb-1">
                                        <span class="small">Total Investment</span>
                                        <span class="badge bg-primary kv-value badge-wrap text-break">{{ construction.total_investment }}</span>
                                    </div>
                                {% endif %}
                                {% if construction.get('value_per_m2') %}
                                    <div class="kv-row mb-1">
                                        <span class="small">Cost per m¬≤</span>
                                        <span class="badge bg-secondary kv-value badge-wrap text-break">‚Ç¨{{ construction.value_per_m2 }}/m¬≤</span>
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        {% endif %}

        <!-- Meta Information -->
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>Information
                </h6>
            </div>
            <div class="card-body">
                <div class="small">
                    <div class="mb-2">
                        <strong>Legal Status:</strong> {{ land.legal_status or 'Unknown' }}
                    </div>
                    <div class="mb-2">
                        <strong>Added:</strong> {% if land.created_at %}{{ land.created_at.strftime('%B %d, %Y at %H:%M') }}{% else %}Unknown{% endif %}
                    </div>
                    {% if land.email_date %}
                        <div class="mb-2">
                            <strong>Email Received:</strong> {{ land.email_date.strftime('%B %d, %Y at %H:%M') }}
                        </div>
                    {% endif %}
                    <div class="mb-2">
                        <strong>Source Email:</strong> 
                        {% if land.source_email_id %}
                            <!-- Check if it's IMAP (not a real Gmail ID) or Gmail API message -->
                            {% if not land.source_email_id.startswith('imap_') %}
                                <!-- Direct Gmail link using message ID (only for Gmail API messages) -->
                                <a href="https://mail.google.com/mail/u/0/#inbox/{{ land.source_email_id }}" 
                                   target="_blank" 
                                   class="btn btn-primary btn-sm me-2"
                                   title="Open original email in Gmail">
                                    <i class="fas fa-envelope me-1"></i>Open in Gmail
                                </a>
                            {% endif %}
                            
                            <!-- Always show search link - build best possible query with available data -->
                            {% set search_parts = [] %}
                            {% set _ = search_parts.append('from:idealista.com') %}
                            
                            {% if land.email_date %}
                                {% set email_date_str = land.email_date.strftime('%Y/%m/%d') %}
                                {% set _ = search_parts.append('after:' + email_date_str) %}
                            {% endif %}
                            
                            {% if land.price %}
                                {% set price_str = (land.price|int)|string %}
                                {% set _ = search_parts.append('"' + price_str + '‚Ç¨"') %}
                            {% endif %}
                            
                            {% if land.area %}
                                {% set area_str = (land.area|int)|string + ' m¬≤' %}
                                {% set _ = search_parts.append('"' + area_str + '"') %}
                            {% endif %}
                            
                            {% if land.municipality %}
                                {% set _ = search_parts.append('"' + land.municipality + '"') %}
                            {% endif %}
                            
                            {% set search_query = search_parts|join(' ') %}
                            
                            <a href="https://mail.google.com/mail/u/0/#search/{{ search_query|urlencode }}" 
                               target="_blank" 
                               class="btn btn-{% if land.source_email_id.startswith('imap_') %}primary{% else %}outline-secondary{% endif %} btn-sm"
                               title="Search for this email in Gmail">
                                <i class="fas fa-{% if land.source_email_id.startswith('imap_') %}envelope{% else %}search{% endif %} me-1"></i>
                                {% if land.source_email_id.startswith('imap_') %}Find in Gmail{% else %}Search in Gmail{% endif %}
                            </a>
                            
                            <!-- Show email metadata if available -->
                            {% if land.email_subject %}
                                <div class="small text-muted mt-1">
                                    <strong>Subject:</strong> {{ land.email_subject[:60] }}{% if land.email_subject|length > 60 %}...{% endif %}
                                </div>
                            {% endif %}
                            {% if land.email_sender %}
                                <div class="small text-muted">
                                    <strong>From:</strong> {{ land.email_sender }}
                                </div>
                            {% endif %}
                        {% else %}
                            <span class="text-warning">
                                <i class="fas fa-exclamation-triangle me-1"></i>No email source available
                            </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Score Modal -->
<div class="modal fade" id="editScoreModal" tabindex="-1" aria-labelledby="editScoreModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('main.update_score', land_id=land.id) }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="editScoreModalLabel">Edit Score</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="score" class="form-label">Manual Score (0-100)</label>
                        <input type="number" class="form-control" id="score" name="score" 
                               min="0" max="100" step="0.1" 
                               value="{{ '%.1f'|format(land.score_total) if land.score_total else 0 }}" required>
                        <div class="form-text">
                            Enter a score between 0 and 100. This will override the automatically calculated score.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Score</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Toggle favorite status for a property
async function toggleFavorite(landId) {
    try {
        const response = await fetch(`/api/land/${landId}/favorite`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (!response.ok) {
            throw new Error('Failed to toggle favorite');
        }

        const data = await response.json();
        if (data.success) {
            // Update all favorite buttons for this land (both .favorite-btn and .favorite-btn-header)
            const buttons = document.querySelectorAll(`[data-land-id="${landId}"].favorite-btn, [data-land-id="${landId}"].favorite-btn-header`);
            buttons.forEach(button => {
                const icon = button.querySelector('i.fa-star');
                if (icon) {
                    if (data.is_favorite) {
                        icon.classList.remove('text-muted');
                        icon.classList.add('text-warning');
                        button.title = 'Remove from favorites';
                    } else {
                        icon.classList.remove('text-warning');
                        icon.classList.add('text-muted');
                        button.title = 'Add to favorites';
                    }
                }
            });
        } else {
            console.error('Toggle favorite failed:', data.error);
        }
    } catch (error) {
        console.error('Error toggling favorite:', error);
    }
}

// Manually set listing status
async function setListingStatus(landId, status) {
    if (!confirm(`Are you sure you want to mark this listing as "${status}"?`)) {
        return;
    }

    try {
        const response = await fetch(`/api/land/${landId}/set-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: status })
        });

        const data = await response.json();

        if (data.success) {
            // Reload page to show updated status
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error setting status:', error);
        alert('Error setting status');
    }
}

// Check listing status on Idealista
async function checkListingStatus(landId) {
    const btn = document.getElementById('recheck-btn') || event.target.closest('button');
    const originalContent = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Checking...';

    try {
        const response = await fetch(`/api/land/${landId}/check-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const data = await response.json();

        if (data.success) {
            if (data.changed) {
                // Status changed, reload page to show new status
                window.location.reload();
            } else {
                btn.innerHTML = '<i class="fas fa-check me-1"></i>No Change';
                setTimeout(() => {
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                }, 2000);
            }
        } else {
            btn.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Error';
            setTimeout(() => {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }, 2000);
        }
    } catch (error) {
        console.error('Error checking status:', error);
        btn.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Error';
        setTimeout(() => {
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }, 2000);
    }
}

// Formatting functions for AI analysis
function renderListItems(items, label, colorClass) {
    if (!items || !Array.isArray(items) || items.length === 0) return '';
    
    const listItems = items.map(item => 
        `<li><i class="fas fa-dot-circle text-${colorClass} me-1"></i>${humanizeEnumLabel(item) || String(item ?? '')}</li>`
    ).join('');
    
    const header = label ? `<div class="fw-semibold mb-1">${label}</div>` : '';
    return `<div class="analysis-list mb-2">${header}<ul class="list-unstyled mb-0">${listItems}</ul></div>`;
}

function renderSimilarProperties(similarProperties) {
    if (!similarProperties || !Array.isArray(similarProperties) || similarProperties.length === 0) {
        return '<p class="text-muted">No similar properties found</p>';
    }
    
    const propertyCards = similarProperties.map(prop => {
        const priceText = prop.price ? `‚Ç¨${prop.price.toLocaleString()}` : 'Price N/A';
        const areaText = prop.area ? `${prop.area.toLocaleString()}m¬≤` : 'Area N/A';
        const scoreText = prop.score_total ? `${prop.score_total.toFixed(1)}/100` : 'Not scored';
        const scoreClass = prop.score_total ? (prop.score_total >= 70 ? 'text-success' : prop.score_total >= 50 ? 'text-warning' : 'text-danger') : 'text-muted';
        
        const landTypeClass = prop.land_type === 'developed' ? 'bg-success' : 'bg-warning';
        
        return `
            <div class="similar-property-card border rounded p-3 mb-2">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">
                            <a href="/lands/${prop.id}" class="text-decoration-none link-body-emphasis">
                                ${prop.title ? prop.title.substring(0, 50) + (prop.title.length > 50 ? '...' : '') : 'Property #' + prop.id}
                            </a>
                        </h6>
                        <div class="d-flex flex-wrap gap-3 small text-muted mb-2">
                            <span><i class="fas fa-euro-sign me-1"></i>${priceText}</span>
                            <span><i class="fas fa-ruler-combined me-1"></i>${areaText}</span>
                            <span><i class="fas fa-map-marker-alt me-1"></i>${prop.municipality || 'Location N/A'}</span>
                        </div>
                    </div>
                    <div class="text-end">
                        <span class="badge ${landTypeClass} small">${(prop.land_type || 'Unknown').charAt(0).toUpperCase() + (prop.land_type || 'unknown').slice(1)}</span>
                        <div class="small ${scoreClass} mt-1">
                            <i class="fas fa-star me-1"></i>${scoreText}
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex gap-2">
                        <a href="/lands/${prop.id}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye me-1"></i>View Details
                        </a>
                        ${prop.url ? `<a href="${prop.url}" target="_blank" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-external-link-alt me-1"></i>Idealista
                        </a>` : ''}
                    </div>
                    <small class="text-muted">Similar property</small>
                </div>
            </div>
        `;
    }).join('');
    
    return propertyCards;
}

function getPriceVerdictClass(verdict) {
    switch(verdict) {
        case 'FAIR_PRICE': return 'bg-success';
        case 'UNDERPRICED': return 'bg-primary';
        case 'OVERPRICED': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

// Removed duplicate - see consolidated version below

function getPriceTrendClass(trend) {
    switch(trend) {
        case 'RISING': return 'bg-success';
        case 'STABLE': return 'bg-info';
        case 'DECLINING': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

function humanizeEnumLabel(value) {
    if (value === null || value === undefined) return '';
    const original = String(value).trim();
    if (!original) return '';

    const rawParts = original.split('-');
    const rawHead = (rawParts.shift() || '').trim();
    const rawTail = rawParts.join('-').trim();

    const isEnumHead = rawHead && /^[A-Z0-9_]+$/.test(rawHead) && /[A-Z]/.test(rawHead);
    if (!isEnumHead) return original;

    const humanHead = rawHead
        .replace(/_/g, ' ')
        .toLowerCase()
        .replace(/\b\w/g, ch => ch.toUpperCase())
        .replace(/\s+/g, ' ')
        .trim();

    if (!rawTail) return humanHead;

    const humanTail = rawTail.replace(/_/g, ' ').replace(/\s+/g, ' ').trim();
    return humanTail ? `${humanHead} - ${humanTail}` : humanHead;
}

// Render structured AI analysis
function renderStructuredAIAnalysis(analysis) {
    console.log('Rendering analysis with structure:', Object.keys(analysis || {}));
    
    // Safety check for empty analysis
    if (!analysis || typeof analysis !== 'object') {
        return '<div class="alert alert-warning">No analysis data available</div>';
    }
    
    try {
        return `
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="border rounded p-3 h-100">
	                        <h6><i class="fas fa-euro-sign text-success"></i> Price Analysis</h6>
	                        ${analysis.price_analysis ? `
	                            <span class="badge ${getPriceVerdictClass(analysis.price_analysis.verdict)}">
	                                ${humanizeEnumLabel(analysis.price_analysis.verdict) || 'Unknown'}
	                            </span>
	                            <p class="mb-1 mt-2">${analysis.price_analysis.summary || 'No analysis available'}</p>
	                            <small class="text-muted">${analysis.price_analysis.recommendation || ''}</small>
	                        ` : `
                            <span class="badge bg-secondary">Analysis Pending</span>
                            <p class="mb-1 mt-2 text-muted">Price analysis will be available after next AI enrichment</p>
                        `}
                    </div>
                </div>
                
                <div class="col-md-6 mb-3">
                    <div class="border rounded p-3 h-100">
	                        <h6><i class="fas fa-chart-line text-primary"></i> Investment Potential</h6>
	                        ${analysis.investment_potential ? `
	                            <span class="badge ${getInvestmentRatingClass(analysis.investment_potential.rating)}">
	                                ${humanizeEnumLabel(analysis.investment_potential.rating) || 'Unknown'} Growth
	                            </span>
	                            <p class="mb-1 mt-2">${analysis.investment_potential.forecast || 'No forecast available'}</p>
	                            <small class="text-muted">Risk: ${humanizeEnumLabel(analysis.investment_potential.risk_level) || 'Unknown'}</small>
	                            ${analysis.investment_potential.key_drivers ? renderListItems(analysis.investment_potential.key_drivers, 'Key Drivers:', 'info') : ''}
	                        ` : `
                            <span class="badge bg-secondary">Analysis Pending</span>
                            <p class="mb-1 mt-2 text-muted">Investment analysis will be available after next AI enrichment</p>
                        `}
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="border rounded p-3 h-100">
                        <h6><i class="fas fa-exclamation-triangle text-warning"></i> Risks & Advantages</h6>
                        ${analysis.risks_analysis ? `
                            ${renderListItems(analysis.risks_analysis.major_risks, 'Risks:', 'danger')}
                            ${renderListItems(analysis.risks_analysis.advantages, 'Advantages:', 'success')}
                            <small class="text-muted">${analysis.risks_analysis.mitigation || ''}</small>
                        ` : analysis.comparable_analysis ? `
                            ${renderListItems(analysis.comparable_analysis.advantages_vs_similar, 'Advantages:', 'success')}
                            ${renderListItems(analysis.comparable_analysis.disadvantages_vs_similar, 'Disadvantages:', 'danger')}
                            <small class="text-muted">Based on market comparison data</small>
                        ` : `
                            <p class="text-muted">Risk analysis will be available after next AI enrichment</p>
                        `}
                    </div>
                </div>
                
	                <div class="col-md-6 mb-3">
	                    <div class="border rounded p-3 h-100">
	                        <h6><i class="fas fa-hammer text-info"></i> Development Ideas</h6>
	                        ${analysis.development_ideas ? `
	                            <p class="mb-1"><strong>${humanizeEnumLabel(analysis.development_ideas.best_use) || 'No recommendations'}</strong></p>
	                            <p class="mb-1">${analysis.development_ideas.building_size || ''}</p>
	                            <small class="text-muted">${analysis.development_ideas.estimated_cost || ''}</small>
	                            ${analysis.development_ideas.special_features ? `<div class="mt-2"><small class="text-info">${analysis.development_ideas.special_features}</small></div>` : ''}
	                        ` : `
                            <p class="text-muted">Development ideas will be available after next AI enrichment</p>
                        `}
                    </div>
                </div>
            </div>
            
            ${analysis.comparable_analysis ? `
	            <div class="border rounded p-3 mb-3">
	                <h6><i class="fas fa-balance-scale text-secondary"></i> Market Comparison</h6>
	                <p class="mb-1">${humanizeEnumLabel(analysis.comparable_analysis.market_position) || 'No comparison data'}</p>
	                <small class="text-muted">${analysis.comparable_analysis.price_comparison || ''}</small>
	            </div>
	            ` : ''}
            
            ${analysis.construction_value_estimation ? `
	            <div class="border rounded p-3 mb-3">
	                <h6><i class="fas fa-calculator text-warning"></i> Construction Value Estimation</h6>
	                <div class="row">
	                    <div class="col-md-4">
	                        <small class="text-muted d-block">Construction Type</small>
	                        <strong>${humanizeEnumLabel(analysis.construction_value_estimation.construction_type) || 'Standard construction'}</strong>
	                    </div>
                    <div class="col-md-4">
                        <small class="text-muted d-block">Est. Construction Value</small>
                        <strong>‚Ç¨${(analysis.construction_value_estimation.minimum_value || 0).toLocaleString()} - ‚Ç¨${(analysis.construction_value_estimation.maximum_value || 0).toLocaleString()}</strong>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted d-block">Total Investment</small>
                        <strong class="text-warning">${analysis.construction_value_estimation.total_investment || 'N/A'}</strong>
                    </div>
                </div>
            </div>
        ` : ''}
        
        <!-- Market Price Dynamics Section -->
        ${analysis.market_price_dynamics ? `
	        <div class="border rounded p-3 mb-3">
	            <h6><i class="fas fa-chart-line text-warning"></i> Market Price Dynamics</h6>
	            <div class="mb-2">
	                <span class="badge ${getPriceTrendClass(analysis.market_price_dynamics.price_trend || analysis.market_price_dynamics.current_trend)}">${humanizeEnumLabel(analysis.market_price_dynamics.price_trend || analysis.market_price_dynamics.current_trend) || 'Unknown'} Trend</span>
	                <span class="badge bg-info ms-1">${analysis.market_price_dynamics.annual_growth_rate || analysis.market_price_dynamics.annual_appreciation || 'N/A'}% annually</span>
	            </div>
	            <p class="mb-2">${analysis.market_price_dynamics.trend_analysis || 'No trend analysis available'}</p>
            ${analysis.market_price_dynamics.market_factors ? renderListItems(analysis.market_price_dynamics.market_factors, 'Market Factors:', 'primary') : ''}
            <small class="text-muted">${analysis.market_price_dynamics.future_outlook || ''}</small>
        </div>
        ` : ''}
        
        <!-- Rental Market Analysis Section -->
        ${analysis.rental_market_analysis ? `
        <div class="border rounded p-3 mb-3">
            <h6><i class="fas fa-key text-info"></i> Rental Market Analysis</h6>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="border rounded p-3">
                        <h6 class="text-warning"><i class="fas fa-coins"></i> Rental Income Estimates</h6>
	                        <div class="row text-center mb-2">
                            <div class="col-4">
                                <small class="text-muted d-block">Min Monthly</small>
                                <strong>‚Ç¨${(analysis.rental_market_analysis.monthly_rent_min || 0).toLocaleString()}</strong>
                            </div>
                            <div class="col-4">
                                <div class="bg-body-tertiary border rounded p-2">
                                    <small class="text-muted d-block">Avg Monthly</small>
                                    <strong class="text-warning">‚Ç¨${(analysis.rental_market_analysis.monthly_rent_avg || 0).toLocaleString()}</strong>
                                </div>
                            </div>
                            <div class="col-4">
                                <small class="text-muted d-block">Max Monthly</small>
                                <strong>‚Ç¨${(analysis.rental_market_analysis.monthly_rent_max || 0).toLocaleString()}</strong>
                            </div>
                        </div>
	                        <p class="mb-1"><strong>Annual Income:</strong> ‚Ç¨${(analysis.rental_market_analysis.annual_rent_avg || 0).toLocaleString()}/year</p>
	                        <p class="mb-0"><small class="text-muted">Strategy: ${humanizeEnumLabel(analysis.rental_market_analysis.rental_strategy) || 'Long-term rental'}</small></p>
	                    </div>
	                </div>
                
                <div class="col-md-6">
                    <div class="border rounded p-3">
                        <h6 class="text-success"><i class="fas fa-chart-pie"></i> Investment Metrics</h6>
                        <div class="row mb-2">
                            <div class="col-6">
                                <small class="text-muted d-block">Rental Yield</small>
                                <div class="d-flex align-items-center">
                                    <strong class="${(analysis.rental_market_analysis.rental_yield && analysis.rental_market_analysis.rental_yield > 5) ? 'text-success' : (analysis.rental_market_analysis.rental_yield && analysis.rental_market_analysis.rental_yield > 4) ? 'text-warning' : 'text-danger'}">${analysis.rental_market_analysis.rental_yield || 'N/A'}%</strong>
                                    <small class="text-muted ms-2">/year</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Cap Rate</small>
                                <div class="d-flex align-items-center">
                                    <strong class="${(analysis.rental_market_analysis.cap_rate && analysis.rental_market_analysis.cap_rate > 4) ? 'text-success' : (analysis.rental_market_analysis.cap_rate && analysis.rental_market_analysis.cap_rate > 3) ? 'text-warning' : 'text-danger'}">${analysis.rental_market_analysis.cap_rate || 'N/A'}%</strong>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted d-block">Price/Rent Ratio</small>
                                <strong class="${getPriceToRentClass(analysis.rental_market_analysis.price_to_rent_ratio)}">${analysis.rental_market_analysis.price_to_rent_ratio || 'N/A'}</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Payback Period</small>
                                <strong class="${getPaybackPeriodClass(analysis.rental_market_analysis.payback_period_years)}">${analysis.rental_market_analysis.payback_period_years || 'N/A'} years</strong>
                            </div>
	                        </div>
	                        <div class="mt-2">
	                            <span class="badge ${getInvestmentRatingClass(analysis.rental_market_analysis.investment_rating)}">${humanizeEnumLabel(analysis.rental_market_analysis.investment_rating) || 'Not rated'}</span>
	                        </div>
	                    </div>
	                </div>
            </div>
            
            ${analysis.rental_market_analysis.demand_factors ? `
            <div class="border rounded p-2 bg-body-tertiary">
                <strong><i class="fas fa-trending-up text-info"></i> Rental Demand Factors:</strong>
                ${renderListItems(analysis.rental_market_analysis.demand_factors, '', 'info')}
            </div>
            ` : ''}
        </div>
        ` : ''}
        
        <!-- Similar Objects - Additional Information -->
        ${analysis.similar_objects ? `
        <div class="card mt-4 similar-objects-card">
            <div class="card-body">
                <div class="d-flex align-items-center gap-2 mb-1">
                    <i class="fas fa-link text-primary"></i>
                    <h6 class="mb-0">Similar Objects</h6>
                </div>
                <p class="mb-3 small text-body-secondary">${analysis.similar_objects.comparison_summary || 'Similar properties from our database:'}</p>
                ${renderSimilarProperties(analysis.similar_properties_data || [])}
            </div>
        </div>
        ` : ''}
    `;
    } catch (renderError) {
        console.error('Template rendering error:', renderError);
        return '<div class="alert alert-danger">Error rendering analysis template. Please refresh the page.</div>';
    }
}

// Helper function for investment rating badge color (consolidated version)
function getInvestmentRatingClass(rating) {
    if (!rating) return 'bg-secondary';
    
    // Convert to uppercase for comparison
    const upperRating = String(rating).toUpperCase();
    
    // Check for both styles of ratings
    if (upperRating === 'HIGH' || upperRating.includes('EXCELLENT')) return 'bg-success';
    if (upperRating.includes('GOOD')) return 'bg-primary';
    if (upperRating === 'MEDIUM' || upperRating.includes('MODERATE')) return 'bg-warning';
    if (upperRating === 'LOW' || upperRating.includes('POOR') || upperRating.includes('BELOW')) return 'bg-danger';
    
    return 'bg-secondary';
}

// Helper function for Price/Rent Ratio color
function getPriceToRentClass(ratio) {
    if (!ratio) return 'text-muted';
    if (ratio < 15) return 'text-success';        // Good - low ratio means faster payback
    if (ratio < 20) return 'text-warning';        // Average 
    return 'text-danger';                         // Poor - high ratio means slow payback
}

// Helper function for Payback Period color  
function getPaybackPeriodClass(years) {
    if (!years) return 'text-muted';
    if (years < 15) return 'text-success';        // Good - quick payback
    if (years < 25) return 'text-warning';        // Average
    return 'text-danger';                         // Poor - very long payback
}

// Make land data available globally for JavaScript
window.landData = {{ land.to_dict() | tojson }};

// Existing analyses (if present)
window.__EXISTING_CLAUDE_ANALYSIS__ = {% if land.ai_analysis %}{{ land.ai_analysis|tojson|safe }}{% else %}null{% endif %};
window.__EXISTING_OPENAI_ANALYSIS__ = {% if openai_analysis %}{{ openai_analysis|tojson|safe }}{% else %}null{% endif %};

// Initialize structured AI analysis on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load model comparison table (Claude vs ChatGPT)
    refreshAiComparison();

    // Render existing analyses into tabs
    renderAnalysisInto('ai-claude-structured-analysis', window.__EXISTING_CLAUDE_ANALYSIS__, 'ai-claude-placeholder');
    renderAnalysisInto('ai-chatgpt-structured-analysis', window.__EXISTING_OPENAI_ANALYSIS__, 'ai-chatgpt-placeholder');
});

function _normalizeAnalysisData(raw) {
    if (raw === null || raw === undefined) return null;
    if (typeof raw === 'object') return raw;
    if (typeof raw === 'string') {
        try {
            return JSON.parse(raw);
        } catch {
            return { _raw_text: raw };
        }
    }
    return { _raw_text: String(raw) };
}

function renderAnalysisInto(targetId, rawData, placeholderId) {
    const target = document.getElementById(targetId);
    if (!target) return;

    const placeholder = placeholderId ? document.getElementById(placeholderId) : null;
    const normalized = _normalizeAnalysisData(rawData);

    if (!normalized) {
        target.innerHTML = '';
        if (placeholder) placeholder.style.display = '';
        return;
    }

    if (placeholder) placeholder.style.display = 'none';

    if (normalized._raw_text) {
        target.innerHTML = `<div class="analysis-text">${String(normalized._raw_text).replace(/\n/g, '<br>')}</div>`;
        return;
    }

    try {
        target.innerHTML = renderStructuredAIAnalysis(normalized);
    } catch (e) {
        target.innerHTML = `<div class="alert alert-warning mb-0">Error rendering analysis: ${e}</div>`;
    }
}

function showTransientAlert(containerId, type, message, autoCloseMs = 4500) {
    // Do not inject inline alerts into the page layout.
    // Use global ephemeral notifications instead.
    const ms = typeof autoCloseMs === 'number' ? autoCloseMs : 3000;
    const notifType = type === 'danger' ? 'error' : (type || 'info');
    if (window.IdealistaApp && typeof window.IdealistaApp.showNotification === 'function') {
        window.IdealistaApp.showNotification(String(message || ''), notifType, ms);
    }
}

function cooldownButton(buttonEl, seconds) {
    if (!buttonEl) return;
    const original = buttonEl.innerHTML;
    let remaining = seconds;
    buttonEl.disabled = true;

    const tick = () => {
        if (remaining <= 0) {
            clearInterval(timer);
            buttonEl.disabled = false;
            buttonEl.innerHTML = original;
            return;
        }
        buttonEl.innerHTML = `<i class="fas fa-clock me-1"></i>Try again in ${remaining}s`;
        remaining -= 1;
    };

    tick();
    const timer = setInterval(tick, 1000);
}

function setActiveAiTab(tabName) {
    const tabId = tabName === 'chatgpt' ? 'ai-chatgpt-tab' : 'ai-claude-tab';
    const trigger = document.getElementById(tabId);
    if (!trigger) return;
    const tab = bootstrap.Tab.getOrCreateInstance(trigger);
    tab.show();
}

function openAiSection(tabName) {
    setActiveAiTab(tabName || 'claude');
    const section = document.getElementById('ai-analysis-section');
    if (section && typeof section.scrollIntoView === 'function') {
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

function analyzeWithClaude(landId) {
    openAiSection('claude');
    runClaudeAnalysis(landId);
}

function runClaudeAnalysis(landId) {
    setActiveAiTab('claude');

    const button = document.getElementById('ai-claude-run-btn');
    const originalContent = button ? button.innerHTML : '';
    const targetId = 'ai-claude-structured-analysis';
    const placeholderId = 'ai-claude-placeholder';
    const alertsId = 'ai-claude-alerts';

    // Keep behavior consistent across providers: clicking "Run" always generates a fresh analysis.
    const isEnrichment = false;

    const target = document.getElementById(targetId);
    const previousHtml = target ? target.innerHTML : '';

    if (button) {
        button.disabled = true;
        button.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Analyzing‚Ä¶`;
    }

    const placeholder = document.getElementById(placeholderId);
    if (placeholder) placeholder.style.display = 'none';

    if (target) {
        target.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted mb-1">Claude is analyzing this property‚Ä¶</p>
                <small class="text-body-secondary">This may take 10-30 seconds</small>
            </div>
        `;
    }

    const requestBody = {};

    fetch(`/api/analyze/property/${landId}/structured`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestBody)
    })
    .then(r => r.json())
    .then(data => {
        if (!data.success) {
            if (target) target.innerHTML = previousHtml;
            showTransientAlert(alertsId, 'warning', `Claude is busy. Try again in 20 seconds.`, 4500);
            return;
        }

        window.__EXISTING_CLAUDE_ANALYSIS__ = data.analysis;

        if (target) {
            target.innerHTML = renderStructuredAIAnalysis(_normalizeAnalysisData(data.analysis));
        }
        if (window.IdealistaApp && typeof window.IdealistaApp.showNotification === 'function') {
            window.IdealistaApp.showNotification('Claude analysis generated', 'success', 3000);
        }

        refreshAiComparison();
    })
    .catch(err => {
        if (target) target.innerHTML = previousHtml;
        showTransientAlert(alertsId, 'warning', `Claude request failed. Try again in 20 seconds.`, 4500);
    })
    .finally(() => {
        if (button) {
            button.disabled = false;
            button.innerHTML = originalContent;
        }
    });
}

function _formatMetricValue(value, suffix='') {
    if (value === null || value === undefined || value === '') return '‚Äî';
    if (typeof value === 'number' && Number.isFinite(value)) {
        return `${value}${suffix}`;
    }
    if (typeof value === 'string') {
        return humanizeEnumLabel(value) || '‚Äî';
    }
    return String(value);
}

function _appendRow(tbody, label, claudeVal, gptVal, baselineVal) {
    const tr = document.createElement('tr');
    const td0 = document.createElement('td');
    td0.className = 'fw-semibold';
    td0.textContent = label;
    const td1 = document.createElement('td');
    td1.textContent = claudeVal;
    const td2 = document.createElement('td');
    td2.textContent = gptVal;
    const td3 = document.createElement('td');
    td3.className = 'text-body-secondary';
    td3.textContent = baselineVal;
    tr.appendChild(td0);
    tr.appendChild(td1);
    tr.appendChild(td2);
    tr.appendChild(td3);
    tbody.appendChild(tr);
}

function _appendSection(tbody, title) {
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 4;
    td.className = 'text-body-secondary small fw-semibold pt-3';
    td.textContent = title;
    tr.appendChild(td);
    tbody.appendChild(tr);
}

async function refreshAiComparison() {
    const statusEl = document.getElementById('ai-compare-status');
    const tableEl = document.getElementById('ai-compare-table');
    const tbody = document.getElementById('ai-compare-tbody');
    const generateBtn = document.getElementById('ai-chatgpt-run-btn');
    const chatgptHint = document.getElementById('ai-chatgpt-config-hint');
    const claudeModelLabel = document.getElementById('ai-claude-model-label');
    const chatgptModelLabel = document.getElementById('ai-chatgpt-model-label');

    if (!statusEl || !tableEl || !tbody) return;

    statusEl.textContent = 'Loading‚Ä¶';
    tableEl.style.display = 'none';
    tbody.textContent = '';

    try {
        const resp = await fetch(`/api/analysis/compare/{{ land.id }}`);
        const data = await resp.json();
        if (!data.success) {
            statusEl.textContent = data.error || 'Failed to load comparison';
            return;
        }

        const openaiConfigured = data.openai_configured === true;
        if (generateBtn) {
            generateBtn.disabled = !openaiConfigured;
            generateBtn.title = openaiConfigured ? 'Run ChatGPT analysis' : 'Set OPENAI_API_KEY in .env and restart app';
        }
        if (chatgptHint) {
            chatgptHint.textContent = openaiConfigured ? '' : 'ChatGPT is not configured: set OPENAI_API_KEY in .env and restart the app.';
        }

        const claude = data.comparison?.claude;
        const gpt = data.comparison?.chatgpt;
        const expected = data.comparison?.expected || {};

        const MISSING = '‚Äî';
        const claudeGenerated = (claude?.schema?.found || 0) > 0;
        const gptGenerated = (gpt?.schema?.found || 0) > 0;

        const c = claude?.metrics || {};
        const g = gpt?.metrics || {};

        _appendRow(
            tbody,
            'Investment rating',
            claudeGenerated ? _formatMetricValue(c.investment_rating) : MISSING,
            gptGenerated ? _formatMetricValue(g.investment_rating) : MISSING,
            _formatMetricValue(expected.investment_rating)
        );
        _appendRow(
            tbody,
            'Rental yield',
            claudeGenerated ? _formatMetricValue(c.rental_yield, '%') : MISSING,
            gptGenerated ? _formatMetricValue(g.rental_yield, '%') : MISSING,
            _formatMetricValue(expected.rental_yield, '%')
        );
        _appendRow(
            tbody,
            'Cap rate',
            claudeGenerated ? _formatMetricValue(c.cap_rate, '%') : MISSING,
            gptGenerated ? _formatMetricValue(g.cap_rate, '%') : MISSING,
            _formatMetricValue(expected.cap_rate, '%')
        );
        _appendRow(
            tbody,
            'Price / rent ratio',
            claudeGenerated ? _formatMetricValue(c.price_to_rent_ratio) : MISSING,
            gptGenerated ? _formatMetricValue(g.price_to_rent_ratio) : MISSING,
            _formatMetricValue(expected.price_to_rent_ratio)
        );
        _appendRow(
            tbody,
            'Payback (years)',
            claudeGenerated ? _formatMetricValue(c.payback_period_years) : MISSING,
            gptGenerated ? _formatMetricValue(g.payback_period_years) : MISSING,
            _formatMetricValue(expected.payback_period_years)
        );

        const ch = claude?.highlights || {};
        const gh = gpt?.highlights || {};

        _appendSection(tbody, 'Qualitative highlights (often differ)');
        _appendRow(
            tbody,
            'Price summary',
            claudeGenerated ? _formatMetricValue(ch.price_summary) : MISSING,
            gptGenerated ? _formatMetricValue(gh.price_summary) : MISSING,
            MISSING
        );
        _appendRow(
            tbody,
            'Key drivers',
            claudeGenerated ? _formatMetricValue(ch.key_drivers) : MISSING,
            gptGenerated ? _formatMetricValue(gh.key_drivers) : MISSING,
            MISSING
        );
        _appendRow(
            tbody,
            'Best use',
            claudeGenerated ? _formatMetricValue(ch.best_use) : MISSING,
            gptGenerated ? _formatMetricValue(gh.best_use) : MISSING,
            MISSING
        );

        _appendSection(tbody, 'Schema + baseline match');
        _appendRow(
            tbody,
            'Schema completeness',
            claudeGenerated ? `${claude?.schema?.found || 0}/${claude?.schema?.total || 0}` : MISSING,
            gptGenerated ? `${gpt?.schema?.found || 0}/${gpt?.schema?.total || 0}` : MISSING,
            MISSING
        );
        _appendRow(
            tbody,
            'Numeric fidelity (vs baseline)',
            claudeGenerated ? _formatMetricValue(claude?.fidelity_score, '/100') : MISSING,
            gptGenerated ? _formatMetricValue(gpt?.fidelity_score, '/100') : MISSING,
            MISSING
        );
        _appendRow(
            tbody,
            'Overall score (baseline)',
            claudeGenerated ? _formatMetricValue(claude?.overall_score, '/100') : MISSING,
            gptGenerated ? _formatMetricValue(gpt?.overall_score, '/100') : MISSING,
            MISSING
        );

        const claudeModel = data.claude_model || 'unknown';
        if (claudeModelLabel) claudeModelLabel.textContent = `Powered by Claude (${claudeModel})`;
        if (chatgptModelLabel) {
            if (data.has_chatgpt) {
                chatgptModelLabel.textContent = `Powered by ChatGPT (${data.chatgpt_model || 'unknown'})`;
            } else {
                chatgptModelLabel.textContent = 'Powered by ChatGPT';
            }
        }
        const statusParts = [];
        statusParts.push(`Claude: ${claudeModel}${claudeGenerated ? '' : ' (not generated)'}`);

        if (!openaiConfigured) {
            statusParts.push('ChatGPT: not configured (set OPENAI_API_KEY in .env, then restart the app).');
        } else if (data.has_chatgpt) {
            statusParts.push(`ChatGPT: ${data.chatgpt_model || 'unknown'}`);
        } else {
            statusParts.push('ChatGPT: not generated (open the ChatGPT tab and click ‚ÄúRun ChatGPT‚Äù).');
        }

        statusEl.textContent = statusParts.join(' ‚Ä¢ ');

        tableEl.style.display = '';
    } catch (e) {
        statusEl.textContent = `Failed to load comparison: ${e}`;
    }
}

async function generateChatGPTAnalysis() {
    try {
        setActiveAiTab('chatgpt');
        const btn = document.getElementById('ai-chatgpt-run-btn');
        const targetId = 'ai-chatgpt-structured-analysis';
        const placeholderId = 'ai-chatgpt-placeholder';
        const alertsId = 'ai-chatgpt-alerts';
        const placeholder = document.getElementById(placeholderId);
        if (placeholder) placeholder.style.display = 'none';

        const target = document.getElementById(targetId);
        const previousHtml = target ? target.innerHTML : '';
        if (target) {
            target.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted mb-1">ChatGPT is analyzing this property‚Ä¶</p>
                    <small class="text-body-secondary">This may take 10-30 seconds</small>
                </div>
            `;
        }

        if (btn) {
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Analyzing‚Ä¶`;
        }

        const resp = await fetch(`/api/analysis/generate/{{ land.id }}/openai`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ force: true })
        });
        const data = await resp.json();
        if (!data.success) {
            if (window.IdealistaApp && typeof window.IdealistaApp.showNotification === 'function') {
                window.IdealistaApp.showNotification(data.error || 'Failed to generate ChatGPT analysis', 'error');
            }
            if (target) target.innerHTML = previousHtml;
            if (resp.status === 429) {
                showTransientAlert(alertsId, 'warning', `Rate limit reached. Try again in 20 seconds.`, 4500);
                cooldownButton(btn, 20);
            } else {
                showTransientAlert(alertsId, 'warning', `ChatGPT failed. Try again in 20 seconds.`, 4500);
            }
            return;
        }

        window.__EXISTING_OPENAI_ANALYSIS__ = data.analysis;

        if (target) {
            target.innerHTML = renderStructuredAIAnalysis(_normalizeAnalysisData(data.analysis));
        }
        if (window.IdealistaApp && typeof window.IdealistaApp.showNotification === 'function') {
            window.IdealistaApp.showNotification('ChatGPT analysis generated', 'success');
        }
        refreshAiComparison();
    } catch (e) {
        if (window.IdealistaApp && typeof window.IdealistaApp.showNotification === 'function') {
            window.IdealistaApp.showNotification(`Failed to generate ChatGPT analysis: ${e}`, 'error');
        }
        showTransientAlert('ai-chatgpt-alerts', 'warning', `ChatGPT request failed. Try again in 20 seconds.`, 4500);
    } finally {
        const btn = document.getElementById('ai-chatgpt-run-btn');
        if (btn) {
            if (!btn.innerHTML.includes('Try again in')) {
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-wand-magic-sparkles me-1"></i>Run ChatGPT`;
            }
        }
    }
}
</script>
{% endblock %}
