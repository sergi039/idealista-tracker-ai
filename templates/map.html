{% extends "base.html" %}

{% block title %}Map - {{ t('app_title') }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1>
                <i class="fas fa-map me-2"></i>
                Properties Map
                <span class="badge bg-secondary">{{ markers|length }}</span>
            </h1>
            <a href="{{ url_for('main.lands') }}" class="btn btn-outline-secondary">
                <i class="fas fa-list me-1"></i>List View
            </a>
        </div>

        <div class="card">
            <div class="card-body p-0">
                <div id="map" style="height: calc(100vh - 250px); min-height: 500px; border-radius: 0.375rem;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Leaflet MarkerCluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Leaflet MarkerCluster JS -->
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<style>
    /* Custom popup styling */
    .leaflet-popup-content-wrapper {
        background: #212529;
        color: #fff;
        border-radius: 8px;
    }
    .leaflet-popup-tip {
        background: #212529;
    }
    .leaflet-popup-content {
        margin: 12px 16px;
        min-width: 250px;
    }
    .property-popup h6 {
        margin-bottom: 10px;
        font-weight: 600;
        color: #fff;
    }
    .property-popup .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 6px;
        font-size: 0.9em;
    }
    .property-popup .info-label {
        color: #adb5bd;
    }
    .property-popup .info-value {
        font-weight: 500;
    }
    .property-popup .links {
        margin-top: 12px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    .property-popup .links a {
        font-size: 0.8em;
        padding: 4px 10px;
    }
    /* Ensure readable button text on colored buttons inside dark popup */
    .property-popup .links a.btn.btn-primary,
    .property-popup .links a.btn.btn-success {
        color: #fff !important;
    }
    .property-popup .links a.btn.btn-primary i,
    .property-popup .links a.btn.btn-success i {
        color: inherit !important;
    }
    .score-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-weight: bold;
        font-size: 0.85em;
    }
    .score-high { background-color: #198754; color: white; }
    .score-medium { background-color: #ffc107; color: black; }
    .score-low { background-color: #dc3545; color: white; }
    .type-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.8em;
    }
    .type-developed { background-color: #198754; color: white; }
    .type-buildable { background-color: #ffc107; color: black; }

    /* Cluster styling */
    .marker-cluster-small {
        background-color: rgba(110, 204, 57, 0.6);
    }
    .marker-cluster-small div {
        background-color: rgba(110, 204, 57, 0.8);
    }
    .marker-cluster-medium {
        background-color: rgba(240, 194, 12, 0.6);
    }
    .marker-cluster-medium div {
        background-color: rgba(240, 194, 12, 0.8);
    }
    .marker-cluster-large {
        background-color: rgba(241, 128, 23, 0.6);
    }
    .marker-cluster-large div {
        background-color: rgba(241, 128, 23, 0.8);
    }

    /* Focused marker: single larger dot with different color */
    @keyframes focusRingPulse {
        0% {
            transform: translate(-50%, -50%) scale(0.7);
            opacity: 0.9;
        }
        70% {
            transform: translate(-50%, -50%) scale(1.25);
            opacity: 0.2;
        }
        100% {
            transform: translate(-50%, -50%) scale(1.3);
            opacity: 0;
        }
    }

    .custom-marker-focus {
        z-index: 1000 !important;
    }
    .custom-marker-focus > div {
        position: relative;
        box-shadow:
            0 0 0 3px rgba(255, 255, 255, 0.95),
            0 0 14px rgba(13, 202, 240, 0.95) !important;
    }
    .custom-marker-focus > div::after {
        content: '';
        position: absolute;
        left: 50%;
        top: 50%;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        border: 2px solid rgba(13, 202, 240, 0.9);
        box-shadow: 0 0 16px rgba(13, 202, 240, 0.65);
        animation: focusRingPulse 1.6s ease-out infinite;
        pointer-events: none;
    }

    /* Close map control */
    .leaflet-control-closemap {
        margin-top: 48px; /* sit under zoom controls */
    }
    .leaflet-control-closemap a {
        background: rgba(33, 37, 41, 0.9);
        color: #fff;
        width: 34px;
        height: 34px;
        line-height: 34px;
        text-align: center;
        font-size: 16px;
        border-radius: 4px;
    }
    .leaflet-control-closemap a:hover {
        background: rgba(13, 202, 240, 0.95);
        color: #000;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Property markers data from Flask
    const markers = {{ markers | tojson | safe }};

    // Initialize map centered on Asturias
    const map = L.map('map').setView([43.36, -5.85], 9);

    // Base layers
    const streetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '&copy; Esri &mdash; Source: Esri, Maxar, Earthstar Geographics'
    });

    const hybrid = L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
        attribution: '&copy; Google'
    });

    // Add default layer
    streetMap.addTo(map);

    // Layer control
    const baseLayers = {
        "Street Map": streetMap,
        "Satellite": satellite,
        "Hybrid": hybrid
    };

    L.control.layers(baseLayers, null, { position: 'topright' }).addTo(map);

    // Create marker cluster group
    const markerCluster = L.markerClusterGroup({
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true
    });

    // Helper function to format price
    function formatPrice(price) {
        if (!price) return 'N/A';
        return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(price);
    }

    // Helper function to format area
    function formatArea(area) {
        if (!area) return 'N/A';
        return new Intl.NumberFormat('es-ES').format(area) + ' mÂ²';
    }

    // Helper function to get score badge
    function getScoreBadge(score) {
        if (!score) return '<span class="text-muted">No score</span>';
        const scoreClass = score >= 70 ? 'score-high' : score >= 50 ? 'score-medium' : 'score-low';
        return `<span class="score-badge ${scoreClass}">${score.toFixed(1)}</span>`;
    }

    // Helper function to get type badge
    function getTypeBadge(landType) {
        if (!landType) return '';
        const typeClass = landType === 'developed' ? 'type-developed' : 'type-buildable';
        return `<span class="type-badge ${typeClass}">${landType.charAt(0).toUpperCase() + landType.slice(1)}</span>`;
    }

    // Create custom icon
    function createIcon(score, options = {}) {
        const isFocused = options.isFocused === true;
        const baseColor = !score ? '#6c757d' : score >= 70 ? '#198754' : score >= 50 ? '#ffc107' : '#dc3545';
        const color = isFocused ? '#0dcaf0' : baseColor;
        const size = isFocused ? 18 : 12;
        const border = isFocused ? 3 : 2;
        const className = isFocused ? 'custom-marker custom-marker-focus' : 'custom-marker';
        return L.divIcon({
            html: `<div style="background-color: ${color}; width: ${size}px; height: ${size}px; border-radius: 50%; border: ${border}px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
            className,
            iconSize: [size + border * 2, size + border * 2],
            iconAnchor: [(size + border * 2) / 2, (size + border * 2) / 2],
            popupAnchor: [0, -8]
        });
    }

    const markerById = new Map();

    // Add markers
    markers.forEach(function(prop) {
        const landId = Number(prop.id);
        if (!Number.isFinite(landId)) return;

        const popupContent = `
            <div class="property-popup">
                <h6>${prop.title}</h6>
                <div class="d-flex gap-2 mb-2">
                    ${getScoreBadge(prop.score)}
                    ${getTypeBadge(prop.land_type)}
                </div>
                <div class="info-row">
                    <span class="info-label">Price:</span>
                    <span class="info-value">${formatPrice(prop.price)}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Area:</span>
                    <span class="info-value">${formatArea(prop.area)}</span>
                </div>
                ${prop.municipality ? `
                <div class="info-row">
                    <span class="info-label">Municipality:</span>
                    <span class="info-value">${prop.municipality}</span>
                </div>
                ` : ''}
                <div class="links">
                    <a href="/lands/${prop.id}" class="btn btn-primary btn-sm">
                        <i class="fas fa-eye me-1"></i>Details
                    </a>
                    ${prop.url ? `
                    <a href="${prop.url}" target="_blank" class="btn btn-success btn-sm">
                        <i class="fas fa-home me-1"></i>Idealista
                    </a>
                    ` : ''}
                    <a href="https://www.google.com/maps?q=${prop.lat},${prop.lon}" target="_blank" class="btn btn-outline-light btn-sm">
                        <i class="fas fa-map-marker-alt me-1"></i>Google Maps
                    </a>
                </div>
            </div>
        `;

        const marker = L.marker([prop.lat, prop.lon], {
            icon: createIcon(prop.score)
        }).bindPopup(popupContent, {
            maxWidth: 300
        });

        markerById.set(landId, { marker, score: prop.score });
        markerCluster.addLayer(marker);
    });

    map.addLayer(markerCluster);

    // Check for focus parameter in URL
    const urlParams = new URLSearchParams(window.location.search);
    const focusId = urlParams.get('focus');

    if (focusId) {
        const focusKey = Number(focusId);
        const focusEntry = markerById.get(focusKey);
        if (focusEntry && focusEntry.marker) {
            const focusLayer = focusEntry.marker;
            // Moderate zoom so user sees approximate area (not max zoom).
            const latlng = focusLayer.getLatLng();
            map.setView(latlng, 12);

            setTimeout(() => {
                const showFocused = () => {
                    const visibleParent = markerCluster.getVisibleParent(focusLayer);
                    if (visibleParent && visibleParent !== focusLayer && visibleParent.spiderfy) {
                        visibleParent.spiderfy();
                    }

                    // Change the focused land marker icon to make it obvious.
                    focusLayer.setIcon(createIcon(focusEntry.score, { isFocused: true }));
                    focusLayer.setZIndexOffset(1000);
                    focusLayer.openPopup();
                };

                // Ensure the marker is visible even if it's currently clustered.
                if (typeof markerCluster.zoomToShowLayer === 'function') {
                    markerCluster.zoomToShowLayer(focusLayer, showFocused);
                } else {
                    showFocused();
                }
            }, 300);
        } else if (markers.length > 0) {
            const bounds = L.latLngBounds(markers.map(m => [m.lat, m.lon]));
            map.fitBounds(bounds, { padding: [20, 20] });
        }
    } else {
        // Fit bounds to show all markers
        if (markers.length > 0) {
            const bounds = L.latLngBounds(markers.map(m => [m.lat, m.lon]));
            map.fitBounds(bounds, { padding: [20, 20] });
        }
    }

    // Add a close/back control on the map
    const CloseControl = L.Control.extend({
        options: { position: 'topleft' },
        onAdd: function() {
            const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-closemap');
            const link = L.DomUtil.create('a', '', container);
            link.href = '#';
            link.title = 'Close map';
            link.innerHTML = '<i class="fas fa-times"></i>';

            L.DomEvent.on(link, 'click', L.DomEvent.stop)
                .on(link, 'click', function() {
                    if (window.history.length > 1) {
                        window.history.back();
                    } else {
                        window.location.href = '/lands';
                    }
                });

            return container;
        }
    });

    map.addControl(new CloseControl());
});
</script>
{% endblock %}
